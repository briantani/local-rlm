<!-- API Key Configuration Modal -->
<div
    x-data="apiKeyModal()"
    @open-api-key-modal.window="open($event.detail)"
    x-show="isOpen"
    x-cloak
    class="fixed inset-0 z-50 overflow-y-auto"
    aria-labelledby="modal-title"
    role="dialog"
    aria-modal="true"
>
    <!-- Backdrop -->
    <div
        class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
        @click="close"
    ></div>

    <!-- Modal Panel -->
    <div class="flex min-h-full items-center justify-center p-4">
        <div
            class="relative transform overflow-hidden rounded-lg bg-white shadow-xl transition-all sm:w-full sm:max-w-lg"
            @click.away="close"
        >
            <!-- Header -->
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg font-medium leading-6 text-gray-900" id="modal-title">
                            Configure API Keys
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                This configuration requires API keys. Keys are stored in memory only and never saved to disk.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- API Key Forms -->
                <div class="mt-6 space-y-4">
                    <!-- Gemini API Key -->
                    <div x-show="needsProvider('Gemini')" x-cloak>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Google Gemini API Key
                            <span class="text-green-600" x-show="getKeyStatus('gemini')">✓ Configured</span>
                        </label>
                        <input
                            type="password"
                            x-model="keys.gemini"
                            placeholder="AIza..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            @keyup.enter="saveKeys"
                        />
                        <p class="mt-1 text-xs text-gray-500">
                            Get your key from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a>
                        </p>
                    </div>

                    <!-- OpenAI API Key -->
                    <div x-show="needsProvider('OpenAI')" x-cloak>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            OpenAI API Key
                            <span class="text-green-600" x-show="getKeyStatus('openai')">✓ Configured</span>
                        </label>
                        <input
                            type="password"
                            x-model="keys.openai"
                            placeholder="sk-..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            @keyup.enter="saveKeys"
                        />
                        <p class="mt-1 text-xs text-gray-500">
                            Get your key from <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 hover:underline">OpenAI Platform</a>
                        </p>
                    </div>

                    <!-- Success/Error Messages -->
                    <div x-show="message" x-cloak class="p-3 rounded-md" :class="messageType === 'error' ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'">
                        <p class="text-sm" x-text="message"></p>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                <button
                    type="button"
                    @click="saveKeys"
                    class="inline-flex w-full justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:ml-3 sm:w-auto sm:text-sm"
                    :disabled="saving"
                >
                    <span x-show="!saving">Save Keys</span>
                    <span x-show="saving" x-cloak>Saving...</span>
                </button>
                <button
                    type="button"
                    @click="close"
                    class="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:mt-0 sm:w-auto sm:text-sm"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function apiKeyModal() {
    return {
        isOpen: false,
        requiredProviders: [],
        keys: {
            gemini: '',
            openai: ''
        },
        message: '',
        messageType: '',
        saving: false,

        open(detail) {
            this.isOpen = true;
            this.requiredProviders = detail.providers || [];
            this.message = '';

            // Pre-fill with existing keys if any
            const session = Alpine.store('sessionStore');
            if (session.apiKeys.gemini) this.keys.gemini = '***configured***';
            if (session.apiKeys.openai) this.keys.openai = '***configured***';
        },

        close() {
            this.isOpen = false;
            this.keys = { gemini: '', openai: '' };
            this.message = '';
        },

        needsProvider(provider) {
            return this.requiredProviders.some(p =>
                p.toLowerCase() === provider.toLowerCase()
            );
        },

        getKeyStatus(provider) {
            const session = Alpine.store('sessionStore');
            return session.apiKeys[provider];
        },

        async saveKeys() {
            this.saving = true;
            this.message = '';

            const session = Alpine.store('sessionStore');
            const keysToSave = [];

            // Prepare keys that need to be saved
            if (this.needsProvider('Gemini') && this.keys.gemini && this.keys.gemini !== '***configured***') {
                keysToSave.push({ provider: 'gemini', key: this.keys.gemini });
            }
            if (this.needsProvider('OpenAI') && this.keys.openai && this.keys.openai !== '***configured***') {
                keysToSave.push({ provider: 'openai', key: this.keys.openai });
            }

            try {
                // Save each key
                for (const { provider, key } of keysToSave) {
                    const success = await session.setApiKey(provider, key);
                    if (!success) {
                        throw new Error(`Failed to save ${provider} key`);
                    }
                }

                this.message = 'API keys saved successfully!';
                this.messageType = 'success';

                // Close modal after 1 second
                setTimeout(() => this.close(), 1000);

            } catch (e) {
                this.message = e.message;
                this.messageType = 'error';
            } finally {
                this.saving = false;
            }
        }
    };
}
</script>
