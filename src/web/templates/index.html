{% extends "base_simple.html" %}

{% block title %}RLM Agent{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col">
    <!-- Simple Header -->
    <header class="bg-white border-b border-gray-200 px-4 py-3">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <span class="text-2xl">üß†</span>
                <h1 class="text-xl font-bold text-gray-900">RLM Agent</h1>
            </div>
            <a href="/configs" class="text-sm text-gray-500 hover:text-gray-700">Configs</a>
        </div>
    </header>

    <!-- Main Chat Area -->
    <main class="flex-1 max-w-4xl w-full mx-auto px-4 py-6" x-data="rlmChat()" x-init="init()">

    <!-- Chat Container -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">

        <!-- Messages Area -->
        <div id="messages" class="min-h-[400px] max-h-[600px] overflow-y-auto p-6 space-y-6">

            <!-- Welcome Message -->
            <div x-show="!taskId && !isRunning" class="text-center py-12 text-gray-500">
                <div class="text-6xl mb-4">üöÄ</div>
                <p class="text-lg">Enter a task below to get started</p>
                <p class="text-sm mt-2">The agent will write and execute Python code to solve your problem</p>
            </div>

            <!-- User's Task -->
            <div x-show="submittedTask" x-cloak class="flex justify-end">
                <div class="bg-blue-600 text-white rounded-lg px-4 py-3 max-w-[80%]">
                    <div class="text-sm font-medium mb-1">You</div>
                    <div class="whitespace-pre-wrap" x-text="submittedTask"></div>
                </div>
            </div>

            <!-- Agent Response Area -->
            <div x-show="taskId" x-cloak class="flex justify-start">
                <div class="bg-gray-100 rounded-lg px-4 py-3 max-w-[90%] w-full">
                    <div class="text-sm font-medium text-gray-700 mb-2">ü§ñ Agent</div>

                    <!-- Loading/Thinking State -->
                    <div x-show="isRunning && !answer" class="flex items-center space-x-2 text-gray-600">
                        <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span x-text="statusMessage || 'Thinking...'"></span>
                    </div>

                    <!-- Live Steps (while running) -->
                    <div x-show="isRunning && steps.length > 0" class="space-y-2 mb-4">
                        <template x-for="(step, idx) in steps" :key="idx">
                            <div class="border-l-2 border-blue-400 pl-3 py-1">
                                <div class="text-xs font-medium text-blue-600" x-text="'Step ' + (idx + 1) + ': ' + step.action"></div>
                                <div x-show="step.code" class="mt-1">
                                    <pre class="bg-gray-800 text-green-400 text-xs p-2 rounded overflow-x-auto max-h-32"><code x-text="step.code"></code></pre>
                                </div>
                                <div x-show="step.output" class="mt-1 text-xs text-gray-600 bg-white p-2 rounded max-h-24 overflow-y-auto">
                                    <pre x-text="step.output"></pre>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Final Answer -->
                    <div x-show="answer" x-cloak>
                        <div class="prose prose-sm max-w-none" x-html="formatMarkdown(answer)"></div>

                        <!-- Execution Summary (collapsible) -->
                        <div x-show="result" x-cloak class="mt-4 pt-4 border-t border-gray-200">
                            <button @click="showDetails = !showDetails"
                                    class="text-sm text-gray-500 hover:text-gray-700 flex items-center space-x-1">
                                <svg class="w-4 h-4 transition-transform" :class="{'rotate-90': showDetails}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                                <span>Details: <span x-text="result?.step_count || 0"></span> steps, $<span x-text="result?.total_cost?.toFixed(4) || '0.00'"></span>, <span x-text="result?.duration_seconds?.toFixed(1) || '0'"></span>s</span>
                            </button>

                            <!-- Expanded Details -->
                            <div x-show="showDetails" x-cloak class="mt-3 space-y-2">
                                <template x-for="(step, idx) in (result?.execution_history || [])" :key="idx">
                                    <div class="bg-white rounded p-3 text-sm">
                                        <div class="font-medium text-gray-700">
                                            Step <span x-text="step.step"></span>:
                                            <span class="px-2 py-0.5 rounded text-xs"
                                                  :class="{
                                                      'bg-blue-100 text-blue-800': step.action === 'CODE',
                                                      'bg-purple-100 text-purple-800': step.action === 'DELEGATE',
                                                      'bg-green-100 text-green-800': step.action === 'ANSWER',
                                                      'bg-gray-100 text-gray-800': !['CODE', 'DELEGATE', 'ANSWER'].includes(step.action)
                                                  }"
                                                  x-text="step.action"></span>
                                        </div>
                                        <div x-show="step.input" class="mt-2">
                                            <div class="text-xs text-gray-500">Input:</div>
                                            <pre class="bg-gray-50 p-2 rounded text-xs overflow-x-auto max-h-40" x-text="step.input"></pre>
                                        </div>
                                        <div x-show="step.output" class="mt-2">
                                            <div class="text-xs text-gray-500">Output:</div>
                                            <pre class="bg-gray-50 p-2 rounded text-xs overflow-x-auto max-h-40" x-text="step.output"></pre>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Error Display -->
                    <div x-show="error" x-cloak class="bg-red-50 border border-red-200 rounded p-3 mt-2">
                        <div class="text-red-800 font-medium">‚ùå Error</div>
                        <div class="text-red-700 text-sm mt-1" x-text="error"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="border-t border-gray-200 p-4 bg-gray-50">
            <!-- Config Selector (compact) -->
            <div class="flex items-center space-x-4 mb-3">
                <label class="text-sm text-gray-600">Config:</label>
                <select x-model="selectedConfig"
                        @change="onConfigChange"
                        :disabled="isRunning"
                        class="text-sm border border-gray-300 rounded px-3 py-1.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Select...</option>
                    <template x-for="config in configs" :key="config.name">
                        <option :value="config.name" x-text="config.name"></option>
                    </template>
                </select>
                <span x-show="selectedConfig" x-cloak class="text-xs text-gray-500" x-text="configDescription"></span>
            </div>

            <!-- Context Path (optional, collapsible) -->
            <div x-show="showContextInput" x-cloak class="mb-3">
                <div class="flex items-center space-x-2">
                    <label class="text-sm text-gray-600">Context folder:</label>
                    <input type="text"
                           x-model="contextPath"
                           :disabled="isRunning"
                           placeholder="/path/to/files"
                           class="flex-1 text-sm border border-gray-300 rounded px-3 py-1.5 focus:ring-2 focus:ring-blue-500">
                    <button @click="showContextInput = false" class="text-gray-400 hover:text-gray-600">‚úï</button>
                </div>
            </div>

            <!-- Task Input -->
            <form @submit.prevent="submitTask" class="flex space-x-3">
                <div class="flex-1 relative">
                    <textarea x-model="taskText"
                              :disabled="isRunning"
                              rows="2"
                              @keydown.enter.meta="submitTask"
                              @keydown.enter.ctrl="submitTask"
                              placeholder="Describe your task... (Cmd/Ctrl+Enter to submit)"
                              class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-12 resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    <button type="button"
                            @click="showContextInput = !showContextInput"
                            class="absolute right-3 top-3 text-gray-400 hover:text-gray-600"
                            title="Add context folder">
                        üìÅ
                    </button>
                </div>
                <button type="submit"
                        :disabled="!canSubmit"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition">
                    <span x-show="!isRunning">Send</span>
                    <span x-show="isRunning" class="flex items-center space-x-1">
                        <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        <span>Running...</span>
                    </span>
                </button>
            </form>

            <!-- Stop Button -->
            <div x-show="isRunning" x-cloak class="mt-2 text-center">
                <button @click="stopTask" class="text-sm text-red-600 hover:text-red-800">
                    ‚èπ Stop execution
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Tips -->
    <div class="mt-4 text-center text-sm text-gray-500">
        <p>üí° The agent writes Python code to solve your problem</p>
    </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
function rlmChat() {
    return {
        // Config
        configs: [],
        selectedConfig: '',
        configDescription: '',

        // Input
        taskText: '',
        contextPath: '',
        showContextInput: false,

        // Session management
        sessionId: null,

        // Execution state
        taskId: null,
        submittedTask: '',
        isRunning: false,
        statusMessage: '',
        steps: [],
        answer: '',
        result: null,
        error: null,
        ws: null,

        // UI state
        showDetails: false,

        async init() {
            await this.initSession();
            await this.loadConfigs();
        },

        async initSession() {
            // Check for existing session
            let sessionId = localStorage.getItem('rlm_session_id');

            if (!sessionId) {
                // Create new session
                try {
                    const response = await fetch('/api/sessions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        sessionId = data.session_id;
                        localStorage.setItem('rlm_session_id', sessionId);
                    }
                } catch (e) {
                    console.error('Failed to create session:', e);
                }
            }

            this.sessionId = sessionId;
        },

        async loadConfigs() {
            try {
                const response = await fetch('/api/configs');
                const data = await response.json();
                this.configs = data.profiles || data || [];

                // Auto-select first config or local-only if available
                const localOnly = this.configs.find(c => c.name === 'local-only');
                if (localOnly) {
                    this.selectedConfig = 'local-only';
                    this.configDescription = localOnly.description;
                } else if (this.configs.length > 0) {
                    this.selectedConfig = this.configs[0].name;
                    this.configDescription = this.configs[0].description;
                }
            } catch (e) {
                console.error('Failed to load configs:', e);
            }
        },

        onConfigChange() {
            const config = this.configs.find(c => c.name === this.selectedConfig);
            this.configDescription = config?.description || '';
        },

        get canSubmit() {
            return this.taskText.trim() && this.selectedConfig && !this.isRunning;
        },

        async submitTask() {
            if (!this.canSubmit) return;

            // Ensure we have a session
            if (!this.sessionId) {
                await this.initSession();
                if (!this.sessionId) {
                    this.error = 'Failed to create session. Please refresh the page.';
                    return;
                }
            }

            // Reset state
            this.submittedTask = this.taskText;
            this.steps = [];
            this.answer = '';
            this.result = null;
            this.error = null;
            this.isRunning = true;
            this.statusMessage = 'Starting...';
            this.showDetails = false;

            try {
                const requestBody = {
                    task: this.taskText,
                    config_name: this.selectedConfig
                };
                if (this.contextPath.trim()) {
                    requestBody.context_path = this.contextPath.trim();
                }

                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': this.sessionId
                    },
                    body: JSON.stringify(requestBody)
                });

                // Handle session expired (server restarted)
                if (response.status === 401 || response.status === 404) {
                    localStorage.removeItem('rlm_session_id');
                    await this.initSession();
                    // Retry once
                    const retryResponse = await fetch('/api/tasks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Session-ID': this.sessionId
                        },
                        body: JSON.stringify(requestBody)
                    });
                    if (!retryResponse.ok) {
                        const error = await retryResponse.json();
                        throw new Error(error.detail || 'Failed to create task');
                    }
                    const task = await retryResponse.json();
                    this.taskId = task.task_id;
                } else if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create task');
                } else {
                    const task = await response.json();
                    this.taskId = task.task_id;
                }

                this.taskText = ''; // Clear input

                this.connectWebSocket();
                this.scrollToBottom();

            } catch (e) {
                this.error = e.message;
                this.isRunning = false;
            }
        },

        connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/tasks/${this.taskId}`;

            this.ws = new WebSocket(wsUrl);

            this.ws.onmessage = (event) => {
                const update = JSON.parse(event.data);
                this.handleUpdate(update);
                this.scrollToBottom();
            };

            this.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                this.error = 'Connection error';
                this.isRunning = false;
            };

            this.ws.onclose = () => {
                this.isRunning = false;
            };
        },

        handleUpdate(update) {
            console.log('Update:', update);  // Debug logging

            switch (update.type) {
                case 'status':
                    this.statusMessage = update.data.status === 'running' ? 'Working...' : update.data.status;
                    break;

                case 'step':
                    // General step update (DELEGATE, INIT, OTHER)
                    this.steps.push({
                        action: update.data.action,
                        code: null,
                        output: update.data.output || update.data.input
                    });
                    this.statusMessage = `Step ${update.data.step}: ${update.data.action}`;
                    break;

                case 'code':
                    // Code generation
                    this.steps.push({
                        action: 'CODE',
                        code: update.data.code,
                        output: null
                    });
                    this.statusMessage = `Step ${update.data.step}: Executing code...`;
                    break;

                case 'output':
                    // Code execution output
                    if (this.steps.length > 0) {
                        const lastStep = this.steps[this.steps.length - 1];
                        if (lastStep.action === 'CODE' && !lastStep.output) {
                            lastStep.output = update.data.output;
                        }
                    }
                    break;

                case 'complete':
                    this.result = update.data;
                    this.answer = update.data.answer || '';
                    this.isRunning = false;
                    this.statusMessage = '';
                    if (this.ws) this.ws.close();
                    break;

                case 'error':
                    this.error = update.data.error;
                    this.isRunning = false;
                    this.statusMessage = '';
                    if (this.ws) this.ws.close();
                    break;
            }
        },

        stopTask() {
            if (this.ws) {
                this.ws.close();
            }
            this.isRunning = false;
            this.statusMessage = 'Stopped';
        },

        formatMarkdown(text) {
            if (!text) return '';
            try {
                return marked.parse(text);
            } catch (e) {
                return text.replace(/\n/g, '<br>');
            }
        },

        scrollToBottom() {
            this.$nextTick(() => {
                const container = document.getElementById('messages');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            });
        }
    };
}
</script>
{% endblock %}
