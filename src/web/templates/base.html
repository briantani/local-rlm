<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}RLM Agent{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>

    <!-- Alpine.js Collapse Plugin (must load before Alpine.js core) -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/app.css">

    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-8">
                    <a href="/" class="flex items-center">
                        <h1 class="text-2xl font-bold text-gray-900">
                            ðŸ§  RLM Agent
                        </h1>
                        <span class="ml-3 text-sm text-gray-500">
                            Recursive Language Model
                        </span>
                    </a>
                    <!-- Navigation Links -->
                    <div class="hidden md:flex items-center space-x-4">
                        <a href="/" class="text-sm text-gray-600 hover:text-gray-900 transition">
                            Home
                        </a>
                        <a href="/configs" class="text-sm text-gray-600 hover:text-gray-900 transition">
                            Configurations
                        </a>
                        <a href="/configs/estimate" class="text-sm text-gray-600 hover:text-gray-900 transition">
                            Cost Estimator
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- API Key Config Button -->
                    <button
                        @click="$dispatch('open-api-key-modal', { providers: ['Gemini', 'OpenAI'] })"
                        class="text-sm px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50 transition flex items-center space-x-1"
                        title="Configure API Keys"
                    >
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                        </svg>
                        <span>API Keys</span>
                    </button>

                    <div x-data class="text-sm text-gray-600">
                        Session: <span class="font-mono text-xs" x-text="$store.sessionStore.sessionId ? $store.sessionStore.sessionId.slice(0, 8) : 'Loading...'"></span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="mt-12 py-6 border-t border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
            <p>RLM Agent - MIT License</p>
        </div>
    </footer>

    <!-- Global Alpine.js State -->
    <script>
        // Session management store
        document.addEventListener('alpine:init', () => {
            Alpine.store('sessionStore', {
                sessionId: null,
                apiKeys: {
                    gemini: false,
                    openai: false
                },

                async init() {
                    // Check if session exists in localStorage
                    let sessionId = localStorage.getItem('rlm_session_id');

                    if (!sessionId) {
                        // Create a new session
                        const response = await fetch('/api/sessions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            sessionId = data.session_id;
                            localStorage.setItem('rlm_session_id', sessionId);
                        } else {
                            console.error('Failed to create session');
                            return;
                        }
                    }

                    this.sessionId = sessionId;
                    await this.checkApiKeys();
                },

                async checkApiKeys() {
                    if (!this.sessionId) return;

                    const response = await fetch(`/api/sessions/${this.sessionId}/keys/status`, {
                        headers: { 'X-Session-ID': this.sessionId }
                    });

                    if (response.ok) {
                        this.apiKeys = await response.json();
                    } else if (response.status === 404) {
                        // Session no longer exists, recreate it
                        localStorage.removeItem('rlm_session_id');
                        await this.init();
                    }
                },

                async setApiKey(provider, key) {
                    if (!this.sessionId) return;

                    const response = await fetch(`/api/sessions/${this.sessionId}/keys`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Session-ID': this.sessionId
                        },
                        body: JSON.stringify({ provider, api_key: key })
                    });

                    if (response.ok) {
                        await this.checkApiKeys();
                        return true;
                    } else if (response.status === 404) {
                        // Session no longer exists (server restarted), recreate it
                        localStorage.removeItem('rlm_session_id');
                        await this.init();
                        // Retry setting the API key with new session
                        return await this.setApiKey(provider, key);
                    }
                    return false;
                },

                getHeaders() {
                    return {
                        'Content-Type': 'application/json',
                        'X-Session-ID': this.sessionId
                    };
                }
            });

            // Initialize session on page load
            Alpine.store('sessionStore').init();
        });
    </script>

    <!-- API Key Modal Component (Global) -->
    {% include 'components/api_key_modal.html' %}

    {% block scripts %}{% endblock %}
</body>
</html>
